# YOLOv5 自动分类系统

一个基于YOLOv5模型的智能图像分类和文件整理系统，采用模块化设计，代码结构清晰，易于维护和扩展。

## 🏗️ 项目结构

```
choose/
├── main.py                           # 主程序入口
├── image_classifier.py               # 图像分类器主类
├── model_manager.py                  # 模型管理模块
├── file_scanner.py                   # 文件扫描模块
├── file_processor.py                 # 文件处理模块
├── config.py                         # 配置文件
├── utils.py                          # 工具函数
├── copy_high_count_ears.py          # 高数量耳号复制工具
├── gpu.onnx                          # GPU模型文件（可选）
├── cpu.onnx                          # CPU模型文件（推荐）
├── requirements.txt                  # 依赖包
└── README.md                         # 项目说明
```

## 🔧 模块说明

### 1. **main.py** - 主程序入口
- 程序启动入口
- 用户交互逻辑
- 错误处理和程序流程控制
- 环境检查和模型文件验证

### 2. **image_classifier.py** - 图像分类器主类
- 整合所有功能模块
- 协调各模块之间的工作流程
- 提供统一的对外接口
- 显示详细的目录结构统计
- 智能分析目录结构
- 生成数量区间统计报告

### 3. **model_manager.py** - 模型管理模块
- 智能模型文件选择（GPU/CPU）
- ONNX模型加载和初始化
- GPU/CPU自动切换和回退
- 图像预处理和推理

### 4. **file_scanner.py** - 文件扫描模块
- 智能扫描根目录下的子目录
- 在每个子目录中查找EPCData文件夹
- 支持多种图片格式
- 提供目录结构分析功能

### 5. **file_processor.py** - 文件处理模块
- 文件复制和分类逻辑
- 智能解析文件夹名称
- 自动创建新的目录结构
- cuboid文件夹同步
- 智能耳号文件夹重命名
- 生成详细统计报告

### 6. **config.py** - 配置文件
- 集中管理所有配置参数
- 易于修改和维护
- 支持不同环境配置

### 7. **utils.py** - 工具函数
- 通用辅助功能
- 进度跟踪器
- 时间和文件大小格式化

### 8. **copy_high_count_ears.py** - 高数量耳号复制工具
- 交互式用户界面
- 自动路径验证
- 完成后可选择打开目标文件夹

## 🚀 使用方法

### **主要功能（图像分类）**

1. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

2. **准备模型文件**
   - **CPU模型（推荐）**: 将 `cpu.onnx` 模型文件放在项目根目录
   - **GPU模型（可选）**: 将 `gpu.onnx` 模型文件放在项目根目录
   - 至少需要其中一个模型文件

3. **运行程序**
   ```bash
   python main.py
   ```

4. **输入目录路径**
   - 输入包含多个子目录的根目录路径
   - 每个子目录下应该包含EPCData文件夹
   - 程序将自动处理所有符合条件的图片

### **高数量耳号复制功能**

运行复制工具：
```bash
python copy_high_count_ears.py
```

- 运行后直接输入score目录路径
- 程序会自动验证路径
- 完成后可选择打开目标文件夹

## 📁 模型文件策略

### **智能模型选择**
系统会自动根据硬件环境选择最合适的模型文件：

#### **GPU模式（优先）**
- **触发条件**: 检测到CUDA支持且存在`gpu.onnx`文件
- **使用文件**: `gpu.onnx`
- **性能**: 最佳（GPU加速）
- **回退**: 如果GPU初始化失败，自动切换到CPU模式

#### **CPU模式（回退）**
- **触发条件**: 
  - CUDA不可用
  - GPU初始化失败
  - 只有`cpu.onnx`文件
- **使用文件**: 优先使用`cpu.onnx`，如果不存在则使用`gpu.onnx`
- **性能**: 良好（CPU执行）
- **兼容性**: 最高

### **模型文件要求**
```
项目根目录/
├── cpu.onnx          # CPU模型文件（推荐，兼容性最好）
├── gpu.onnx          # GPU模型文件（可选，性能最佳）
└── 其他文件...
```

### **自动检测流程**
1. **环境检查**: 检测CUDA支持和可用性
2. **文件检查**: 检查`gpu.onnx`和`cpu.onnx`文件
3. **智能选择**: 
   - 有CUDA + 有`gpu.onnx` → GPU模式
   - 无CUDA 或 无`gpu.onnx` → CPU模式
4. **自动回退**: GPU失败时自动切换到CPU模式

## 📁 目录结构要求

### **输入目录结构**
您的根目录应该包含多个子目录，每个子目录下有EPCData文件夹：

```
根目录/
├── 目录1/           # 包含EPCData的目录
│   └── EPCData/
│       └── 00000010-2025-06-21-10-41-09-066/
│           └── basicPoint.jpg
├── 目录2/           # 包含EPCData的目录
│   └── EPCData/
│       └── 00000101-2025-06-22-13-57-51-584/
│           └── basicPoint.jpg
└── 目录3/           # 包含EPCData的目录
    └── EPCData/
        └── 000000123-2025-06-23-14-30-15-789/
            └── basicPoint.jpg
```

### **智能文件夹解析**
程序会自动解析文件夹名称格式，支持不同位数的耳号：

#### **支持的耳号格式**
- `00000010-2025-06-21-10-41-09-066` → 耳号: 10
- `00000101-2025-06-22-13-57-51-584` → 耳号: 101  
- `000000123-2025-06-23-14-30-15-789` → 耳号: 123
- `0000001-2025-06-24-09-15-30-456` → 耳号: 1

#### **格式说明**
- **前导零 + 耳号**: 支持任意数量的前导零
- **2025-06-21**: 日期格式 (YYYY-MM-DD)
- **10-41-09**: 时间格式 (HH-MM-SS)
- **066**: 序列号

### **分类后的目录结构**

#### **第一阶段：正常分类结构**
```
score/
├── 2025-06-21/                    # 日期
│   ├── 10/                        # 耳号
│   │   ├── 80/                    # 分数区间(80-89)
│   │   │   └── 00000010-2025-06-21-10-41-09-066/  # 具体文件夹
│   │   └── cuboid/                # cuboid数据
│   ├── 101/                       # 耳号101
│   │   ├── 90/                    # 分数区间(90-99)
│   │   │   └── 00000101-2025-06-22-13-57-51-584/
│   │   └── cuboid/
│   └── 123/                       # 耳号123
│       ├── undetected/            # 未检测到目标
│       │   └── 000000123-2025-06-23-14-30-15-789/
│       └── cuboid/
└── 2025-06-22/                    # 另一个日期
    └── 456/                       # 耳号456
        └── undetected/            # 未检测到目标
            └── 000000456-2025-06-22-15-20-30-123/
```

#### **第二阶段：重命名后（添加数量信息）**
```
score/
├── 2025-06-21/                    # 日期
│   ├── 10-1/                      # 耳号10，包含1个有效文件夹
│   │   ├── 80/                    # 分数区间(80-89)
│   │   │   └── 00000010-2025-06-21-10-41-09-066/  # 具体文件夹
│   │   └── cuboid/                # cuboid数据
│   ├── 101-1/                     # 耳号101，包含1个有效文件夹
│   │   ├── 90/                    # 分数区间(90-99)
│   │   │   └── 00000101-2025-06-22-13-57-51-584/
│   │   └── cuboid/
│   └── 123/                       # 耳号123（未重命名，因为只有undetected）
│       ├── undetected/            # 未检测到目标
│       │   └── 000000123-2025-06-23-14-30-15-789/
│       └── cuboid/
└── 2025-06-22/                    # 另一个日期
    └── 456/                       # 耳号456（未重命名，因为只有undetected）
        └── undetected/            # 未检测到目标
            └── 000000456-2025-06-22-15-20-30-123/
```

### **耳号文件夹命名规则**
- **格式**: `耳号-有效文件夹数量`
- **示例**: 
  - `10-1`: 耳号10，包含1个有效文件夹
  - `10-2`: 耳号10，包含2个有效文件夹
  - `101-1`: 耳号101，包含1个有效文件夹
- **重要说明**: 
  - 只有包含有效检测结果的耳号才会被重命名
  - `undetected` 文件夹中的耳号不会被重命名
  - 统计时只计算有效检测的文件夹数量

### **分数分类规则**
- 置信度 0.0-0.09 → undetected (未检测到)
- 置信度 0.1-0.19 → 10
- 置信度 0.2-0.29 → 20
- ...以此类推
- 置信度 0.9-1.0 → 90

## 📊 统计报告功能

### **自动生成统计报告**
程序处理完成后会自动生成 `statistics_report.txt` 文件，包含：

#### **数量区间统计**
- 大于2个有效文件夹的耳号数量（包括3、4、5...）
- 大于3个有效文件夹的耳号数量（包括4、5...）
- 大于4个有效文件夹的耳号数量（包括5...）
- 大于5个有效文件夹的耳号数量

#### **统计逻辑说明**
- **累加统计**: 大于2的数量包括大于3、大于4、大于5的数量
- **示例**: 如果有5个耳号包含3个以上文件夹，那么：
  - 大于2个文件夹的耳号数量: 5
  - 大于3个文件夹的耳号数量: 5
  - 大于4个文件夹的耳号数量: 3
  - 大于5个文件夹的耳号数量: 1

#### **详细统计信息**
- 按日期分组统计
- 每个耳号包含的有效文件夹数量
- 按文件夹数量排序显示

#### **重要说明**
- **仅统计有效检测的耳号**：undetected文件夹不计入统计
- **有效文件夹定义**：除cuboid和undetected外的所有文件夹
- **统计逻辑**：只有被重命名的耳号文件夹才会被统计

#### **报告示例**
```
============================================================
YOLOv5 自动分类系统 - 统计报告
============================================================

📋 说明：本报告仅统计有效检测的耳号，undetected文件夹不计入统计

📊 总体统计
------------------------------
大于2个有效文件夹的耳号数量: 5
大于3个有效文件夹的耳号数量: 3
大于4个有效文件夹的耳号数量: 1
大于5个有效文件夹的耳号数量: 0

📋 详细统计（按日期）
------------------------------
📅 日期: 2025-06-21
  🏷️  耳号 10: 3 个有效文件夹
  🏷️  耳号 101: 1 个有效文件夹
  🏷️  耳号 123: 0 个有效文件夹（只有undetected，不计入统计）

🎯 总结
------------------------------
有效耳号数量: 2
总日期数量: 1
============================================================
```

## 📁 高数量耳号复制功能

### **功能说明**
复制score目录中大于等于2个有效文件夹的耳号到新文件夹，同时复制undetected文件夹，方便后续分析和人工检查。

### **复制规则**
- **触发条件**：耳号包含大于等于2个有效文件夹（包括2个）
- **undetected复制**：自动复制undetected文件夹，方便人工检查未检测到的内容
- **目标文件夹**：`new/`（默认）
- **命名格式**：`日期_耳号-数量`
- **复制内容**：整个耳号文件夹（包含所有分数文件夹和cuboid）

### **复制示例**
```
new/
├── undetected/                     # undetected文件夹（方便人工检查）
├── 2025-06-21_10-2/              # 日期_耳号-数量（2个有效文件夹）
│   ├── 80/                        # 分数区间(80-89)
│   │   └── 00000010-2025-06-21-10-41-09-066/
│   ├── 90/                        # 分数区间(90-99)
│   │   └── 00000010-2025-06-21-10-41-07-745/
│   └── cuboid/                    # cuboid数据
├── 2025-06-21_101-3/             # 日期_耳号-数量（3个有效文件夹）
│   ├── 70/                        # 分数区间(70-79)
│   ├── 80/                        # 分数区间(80-89)
│   ├── 90/                        # 分数区间(90-99)
│   └── cuboid/
└── 2025-06-22_456-2/             # 另一个包含2个有效文件夹的耳号
    ├── 80/                        # 分数区间(80-89)
    ├── 95/                        # 分数区间(95-99)
    └── cuboid/
```

### **复制统计信息**
程序会显示详细的复制信息：
- 复制的耳号数量
- 复制的undetected文件夹数量
- 总文件大小
- 目标文件夹位置
- 每个耳号的复制状态

### **使用场景**
- 快速筛选出包含2个或更多有效检测结果的耳号
- 人工检查undetected文件夹中的内容，分析未检测原因
- 为后续的深度分析准备数据
- 减少手动筛选的工作量

## ✨ 重构优势

### **模块化设计**
- 每个模块职责单一，易于理解和维护
- 模块间耦合度低，便于独立测试和修改
- 支持功能扩展和定制

### **智能文件组织**
- 自动解析文件夹名称中的日期和耳号信息
- 按照逻辑层次组织文件结构
- 支持多种命名格式的扩展
- 智能扫描多层目录结构
- 支持任意位数的耳号（自动去除前导零）
- 智能耳号文件夹重命名（显示有效文件夹数量）
- 自动生成详细统计报告
- 智能排除undetected文件夹
- 高数量耳号自动复制功能

### **智能模型管理**
- 自动检测硬件环境（GPU/CPU）
- 智能选择最合适的模型文件
- 自动回退机制（GPU失败时切换到CPU）
- 支持多种模型文件格式

### **代码复用**
- 通用功能抽象为工具函数
- 配置参数集中管理
- 减少重复代码

### **可维护性**
- 清晰的代码结构和注释
- 统一的错误处理机制
- 便于调试和问题定位

### **可扩展性**
- 易于添加新的图片格式支持
- 可以轻松集成不同的AI模型
- 支持自定义分类规则和目录结构

## 🔍 核心功能

- **智能检测**: 使用YOLOv5模型自动检测图片中的目标
- **智能分类**: 根据检测置信度自动分类到不同分数文件夹
- **智能组织**: 自动解析文件夹名称，按日期、耳号、分数组织
- **智能扫描**: 自动识别多层目录结构，找到所有EPCData文件夹
- **智能解析**: 支持多种耳号格式，自动去除前导零
- **智能重命名**: 自动统计并显示每个耳号下的有效文件夹数量
- **智能统计**: 自动生成数量区间统计报告
- **智能过滤**: 自动排除undetected文件夹，只统计有效检测结果
- **智能复制**: 自动复制高数量耳号到新文件夹
- **智能模型选择**: 自动选择GPU或CPU模型文件
- **文件同步**: 自动复制相关文件夹和cuboid数据
- **进度跟踪**: 实时显示处理进度和剩余时间
- **结构统计**: 显示详细的目录结构统计信息
- **错误处理**: 完善的异常处理和用户提示

## 📝 注意事项

- 确保有足够的磁盘空间存储分类后的文件
- **模型文件要求**：
  - 至少需要`cpu.onnx`或`gpu.onnx`中的一个
  - `cpu.onnx`兼容性最好，推荐使用
  - `gpu.onnx`性能最佳，但需要CUDA支持
- 建议在处理大量文件前先备份原始数据
- 支持GPU加速，但CPU也能正常工作
- 文件夹名称必须符合指定格式才能正确解析
- 根目录下应该包含多个子目录，每个子目录下有EPCData文件夹
- 支持任意位数的耳号，程序会自动去除前导零
- 耳号文件夹会在处理完成后自动重命名，显示包含的有效文件夹数量
- **undetected文件夹中的耳号不会被重命名，也不会计入统计**
- 统计报告会自动保存为 `statistics_report.txt` 文件
- 统计时只计算有效检测的文件夹，排除undetected和cuboid文件夹
- **高数量耳号会自动复制到 `new/` 文件夹**
- 复制功能会显示详细的统计信息和文件大小
- **程序会自动检测硬件环境并选择最合适的模型文件**

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个项目！
